
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>iotbx.pdb tutorial: pdb_truncate_to_ala &#8212; CCTBX Developer documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CCTBX Developer documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">iotbx.pdb tutorial: <code class="docutils literal notranslate"><span class="pre">pdb_truncate_to_ala</span></code></a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="iotbx-pdb-tutorial-pdb-truncate-to-ala">
<h1>iotbx.pdb tutorial: <code class="docutils literal notranslate"><span class="pre">pdb_truncate_to_ala</span></code><a class="headerlink" href="#iotbx-pdb-tutorial-pdb-truncate-to-ala" title="Permalink to this headline">¶</a></h1>
<p>This tutorial was written by Ralf Grosse-Kunstleve for the 2008
<a class="reference external" href="http://www.sbgrid.org">SBGrid</a> meeting.  It is designed for novices to
CCTBX (or programming in general), but gives a good practical overview of how
the <code class="xref py py-mod docutils literal notranslate"><span class="pre">iotbx.pdb</span></code> facilities may be used.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pdb_truncate_to_ala</span></code> tutorial shows how to use the <code class="docutils literal notranslate"><span class="pre">iotbx.pdb</span></code>
module to truncate the amino-acid residues in a PDB file to alanine
(e.g. in preparation for molecular replacement). The tutorial consists
of five scripts with increasing sophistication:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt><a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v0_getting_started.py">v0_getting_started.py</a></dt><dd><p>Reads a PDB file and shows some information about the content.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v1_loop_over_atoms.py">v1_loop_over_atoms.py</a></dt><dd><p>Also loops over the atoms in the PDB file and prints
residue information and atom names.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v2_simple.py">v2_simple.py</a></dt><dd><p>Simple version removing amino-acid side chain atoms,
except C-beta.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v3_better.py">v3_better.py</a></dt><dd><p>Improved removal of side chain atoms that works even if
there are alternative conformations with a mix of
residue names.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v4_with_bells_and_whistles.py">v4_with_bells_and_whistles.py</a></dt><dd><p>Additional bookkeeping for a few informative print statements.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>The full source listing for these scripts is shown at the end of this document.</p>
</section>
<section id="use-print-and-help">
<h2>Use print and help()!<a class="headerlink" href="#use-print-and-help" title="Permalink to this headline">¶</a></h2>
<p>Before you study any of the scripts below, install the CCTBX.
This will enable you to run the scripts. Use the
PDB files in the <a href="#id6"><span class="problematic" id="id7">`Tutorial directory`_</span></a> as inputs, or any other PDB file
you may have. While analyzing a script, insert <code class="docutils literal notranslate"><span class="pre">print</span></code> statements
and run the script to find out more about the objects. It may also
be useful to insert <code class="docutils literal notranslate"><span class="pre">help(obj)</span></code> to see the attributes and methods of
<code class="docutils literal notranslate"><span class="pre">obj</span></code>, where <code class="docutils literal notranslate"><span class="pre">obj</span></code> can be any of the objects created in the script.</p>
<p>If you don’t know what an object is: <em>thing</em> is a pretty good
approximation.</p>
</section>
<section id="v0-getting-started-py">
<h2><code class="docutils literal notranslate"><span class="pre">v0_getting_started.py</span></code><a class="headerlink" href="#v0-getting-started-py" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">iotbx.pdb</span></code> module implements highly efficient procedures for:</p>
<ul>
<li><p>Processing the records (i.e. lines) in a PDB file.</p></li>
<li><p>Constructing a <em>hierarchy</em> object. This is a five-deep nested
data structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span>
  <span class="n">chain</span>
    <span class="n">residue_group</span>
      <span class="n">atom_group</span>
        <span class="n">atom</span>
</pre></div>
</div>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">v0_getting_started.py</span></code> is a complete Python script for executing
these steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">iotbx.pdb</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please specify one or more pdb file names.&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
    <span class="n">pdb_obj</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">overall_counts</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
  <span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
<p>Most of this script is so called <em>boilerplate</em> code, i.e. code that in
some form or shape is found in most Python scripts. At the beginning of
the script are <code class="docutils literal notranslate"><span class="pre">import</span></code> statements. These import the modules needed
for a task. The bottom lines represent best practice. They enable
the script to be imported and used from other Python scripts. The
first two lines of the <code class="docutils literal notranslate"><span class="pre">run()</span></code> function are a minimalistic - but
often sufficient - way to give users a hint how to use the script. It
works both for someone reading the source code of the script, and a
user running the script without arguments. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">python</span> <span class="n">v0_getting_started</span><span class="o">.</span><span class="n">py</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;v0_getting_started.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">12</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
  <span class="n">File</span> <span class="s2">&quot;v0_getting_started.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">6</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please specify one or more pdb file names.&quot;</span><span class="p">)</span>
<span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">Please</span> <span class="n">specify</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">pdb</span> <span class="n">file</span> <span class="n">names</span><span class="o">.</span>
</pre></div>
</div>
<p>In addition to showing the error message, Python is so friendly show
us exactly where the error originates. This is often extremely helpful.</p>
<p>The meat of the script is in these two lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdb_obj</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
<span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">overall_counts</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The first line executes the two steps outline above. This is really
all we need, but the second line produces output that is useful to
give the user a quick overview of what is in the PDB file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">python</span> <span class="n">v0_getting_started</span><span class="o">.</span><span class="n">py</span> <span class="n">crambin_pieces</span><span class="o">.</span><span class="n">pdb</span>
<span class="n">total</span> <span class="n">number</span> <span class="n">of</span><span class="p">:</span>
  <span class="n">models</span><span class="p">:</span>      <span class="mi">1</span>
  <span class="n">chains</span><span class="p">:</span>      <span class="mi">2</span>
  <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span><span class="p">:</span>  <span class="mi">4</span>
  <span class="n">residues</span><span class="p">:</span>    <span class="mi">3</span>
  <span class="n">atoms</span><span class="p">:</span>      <span class="mi">23</span>
  <span class="n">anisou</span><span class="p">:</span>      <span class="mi">0</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">atom</span> <span class="n">element</span><span class="o">+</span><span class="n">charge</span> <span class="n">types</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">histogram</span> <span class="n">of</span> <span class="n">atom</span> <span class="n">element</span><span class="o">+</span><span class="n">charge</span> <span class="n">frequency</span><span class="p">:</span>
  <span class="s2">&quot; C  &quot;</span> <span class="mi">16</span>
  <span class="s2">&quot; O  &quot;</span>  <span class="mi">5</span>
  <span class="s2">&quot; N  &quot;</span>  <span class="mi">2</span>
<span class="n">residue</span> <span class="n">name</span> <span class="n">classes</span><span class="p">:</span>
  <span class="s2">&quot;common_amino_acid&quot;</span> <span class="mi">2</span>
  <span class="s2">&quot;other&quot;</span>             <span class="mi">1</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">chain</span> <span class="n">ids</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">histogram</span> <span class="n">of</span> <span class="n">chain</span> <span class="nb">id</span> <span class="n">frequency</span><span class="p">:</span>
  <span class="s2">&quot; &quot;</span> <span class="mi">1</span>
  <span class="s2">&quot;A&quot;</span> <span class="mi">1</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span> <span class="n">ids</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">histogram</span> <span class="n">of</span> <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span> <span class="nb">id</span> <span class="n">frequency</span><span class="p">:</span>
  <span class="s2">&quot;A&quot;</span> <span class="mi">2</span>
  <span class="s2">&quot;B&quot;</span> <span class="mi">2</span>
<span class="n">residue</span> <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span> <span class="n">situations</span><span class="p">:</span>
  <span class="n">pure</span> <span class="n">main</span> <span class="n">conf</span><span class="o">.</span><span class="p">:</span>     <span class="mi">1</span>
  <span class="n">pure</span> <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span><span class="p">:</span>     <span class="mi">1</span>
  <span class="n">proper</span> <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span><span class="p">:</span>   <span class="mi">1</span>
  <span class="n">improper</span> <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">chains</span> <span class="k">with</span> <span class="n">mix</span> <span class="n">of</span> <span class="n">proper</span> <span class="ow">and</span> <span class="n">improper</span> <span class="n">alt</span><span class="o">.</span> <span class="n">conf</span><span class="o">.</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">number</span> <span class="n">of</span> <span class="n">residue</span> <span class="n">names</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">histogram</span> <span class="n">of</span> <span class="n">residue</span> <span class="n">name</span> <span class="n">frequency</span><span class="p">:</span>
  <span class="s2">&quot;EOH&quot;</span> <span class="mi">1</span>    <span class="n">other</span>
  <span class="s2">&quot;ILE&quot;</span> <span class="mi">1</span>
  <span class="s2">&quot;SER&quot;</span> <span class="mi">1</span>
</pre></div>
</div>
</section>
<section id="v1-loop-over-atoms-py">
<h2><code class="docutils literal notranslate"><span class="pre">v1_loop_over_atoms.py</span></code><a class="headerlink" href="#v1-loop-over-atoms-py" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">model</span></code>, <code class="docutils literal notranslate"><span class="pre">chain</span></code>, and <code class="docutils literal notranslate"><span class="pre">atom</span></code> levels of the hierarchy
object are probably immediately obvious to someone familiar with
the content of PDB files. The <code class="docutils literal notranslate"><span class="pre">residue_group</span></code> and <code class="docutils literal notranslate"><span class="pre">atom_group</span></code>
levels are more complex. This complexity is related to <em>alternative
conformations</em>. If there are no alternative conformations in
a PDB file, all residue groups contain exactly one atom group,
which contains all the atoms of a residue. A file with alternative
conformations will lead to residue groups with multiple atom groups,
one for each conformer. The <a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/crambin_pieces.pdb">crambin_pieces.pdb</a> file used above
is a file with alternative conformations (about 24% of the files
in the PDB database contain alternative conformations).</p>
<p>To truncate amino-acid residues to alanine, we need to know which
residues are amino-acids, and the atom names. A more detailed
presentation of the hierarchy object shows where we can find this
information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span>
  <span class="nb">id</span>
  <span class="n">chain</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="nb">id</span>
    <span class="n">residue_group</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">resid</span>
      <span class="n">atom_group</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">altloc</span><span class="p">,</span> <span class="n">resname</span>
        <span class="n">atom</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
          <span class="n">name</span>
          <span class="n">segid</span>
          <span class="n">element</span>
          <span class="n">charge</span>
          <span class="n">serial</span>
          <span class="n">xyz</span> <span class="n">sigxyz</span>
          <span class="n">occ</span> <span class="n">sigocc</span>
          <span class="n">b</span> <span class="n">sigb</span>
          <span class="n">uij</span> <span class="n">siguij</span>
          <span class="n">hetero</span>
</pre></div>
</div>
<p>We don’t need all this information for the truncation procedure,
just this subset of the hierarchy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span>
  <span class="n">chain</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">residue_group</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">resid</span>
      <span class="n">atom_group</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">altloc</span><span class="p">,</span> <span class="n">resname</span>
        <span class="n">atom</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
          <span class="n">name</span>
</pre></div>
</div>
<p>This presentation translates directly into Python code,
as found in <a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v1_loop_over_atoms.py">v1_loop_over_atoms.py</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">iotbx.pdb</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please specify one or more pdb file names.&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
    <span class="n">pdb_obj</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">overall_counts</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">models</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residue_groups</span><span class="p">():</span>
          <span class="nb">print</span> <span class="s1">&#39;resid: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">rg</span><span class="o">.</span><span class="n">resid</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
            <span class="nb">print</span> <span class="s1">&#39;  altloc: &quot;</span><span class="si">%s</span><span class="s1">&quot;, resname: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">altloc</span><span class="p">,</span> <span class="n">ag</span><span class="o">.</span><span class="n">resname</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ag</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
              <span class="nb">print</span> <span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>

<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
  <span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
<p>The script contains interleaved print statements. The output of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">python</span> <span class="n">v1_loop_over_atoms</span><span class="o">.</span><span class="n">py</span> <span class="n">crambin_pieces</span><span class="o">.</span><span class="n">pdb</span>
</pre></div>
</div>
<p>can be found here:
<a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v1_loop_over_atoms_crambin_pieces.out">http://cctbx.sourceforge.net/sbgrid2008/v1_loop_over_atoms_crambin_pieces.out</a></p>
</section>
<section id="v2-simple-py">
<h2><code class="docutils literal notranslate"><span class="pre">v2_simple.py</span></code><a class="headerlink" href="#v2-simple-py" title="Permalink to this headline">¶</a></h2>
<p>We have residue names and atom names now, but we still need the
information to decide what residues are amino acids, and what atom
names we want to keep.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">iotbx.pdb</span></code> module contains a sub-module <code class="docutils literal notranslate"><span class="pre">amino_acid_codes</span></code>.
This sub-module contains two Python dictionaries, one of which is
(shortened):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">one_letter_given_three_letter</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;ALA&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
<span class="s2">&quot;ARG&quot;</span><span class="p">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
<span class="o">...</span>
<span class="s2">&quot;TYR&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
<span class="s2">&quot;VAL&quot;</span><span class="p">:</span> <span class="s2">&quot;V&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>We don’t need the one-letter codes, but we can re-use the keys of
this dictionary to efficently decide if a residue name corresponds
to an amino acid. The relevant lines in <a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v2_simple.py">v2_simple.py</a> are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">iotbx.pdb.amino_acid_codes</span>
<span class="o">...</span>
  <span class="n">aa_resnames</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">amino_acid_codes</span><span class="o">.</span><span class="n">one_letter_given_three_letter</span>
<span class="o">...</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">resname</span> <span class="ow">in</span> <span class="n">aa_resnames</span><span class="p">):</span>
</pre></div>
</div>
<p>For the atom names, we use a Python <code class="docutils literal notranslate"><span class="pre">set</span></code>. The relevant lines
in <a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v2_simple.py">v2_simple.py</a> are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ala_atom_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot; N  &quot;</span><span class="p">,</span> <span class="s2">&quot; CA &quot;</span><span class="p">,</span> <span class="s2">&quot; C  &quot;</span><span class="p">,</span> <span class="s2">&quot; O  &quot;</span><span class="p">,</span> <span class="s2">&quot; CB &quot;</span><span class="p">])</span>
<span class="o">...</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ala_atom_names</span><span class="p">):</span>
</pre></div>
</div>
<p>We use a Python <code class="docutils literal notranslate"><span class="pre">set</span></code> because it uses hashing techniques for element
lookup when processing the <code class="docutils literal notranslate"><span class="pre">in</span></code> in the <code class="docutils literal notranslate"><span class="pre">if</span></code> statement. For a
small list like here it doesn’t really matter, but in Python it is
so easy to use advanced hashing techniques, simply by converting the
<code class="docutils literal notranslate"><span class="pre">list</span></code> of atom names to a <code class="docutils literal notranslate"><span class="pre">set</span></code>, there is no reason not to take
advantage of them.</p>
<p>Now that we know which residues we want to truncate, and which atom
names we want to keep, we just need one more line to remove the
side chain atoms:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ag</span><span class="o">.</span><span class="n">remove_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
</pre></div>
</div>
<p>This removes the atom from the atom group. The only thing left to
do once the nested loops over the hierarchy are finished, is to
write the modified hierarchy to a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_pdb</span> <span class="o">=</span> <span class="s2">&quot;v2_truncated_to_ala_&quot;</span><span class="o">+</span><span class="n">file_name</span>
<span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">write_pdb_file</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">output_pdb</span><span class="p">)</span>
</pre></div>
</div>
<p>The first line builds the output file name by concatenating two
strings with the <code class="docutils literal notranslate"><span class="pre">+</span></code> operator. In the second line the
<code class="docutils literal notranslate"><span class="pre">.write_pdb_file()</span></code> method of the hierarchy object is used
to write the file to disk.</p>
<p>The complete source for this script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">iotbx.pdb</span>
<span class="kn">import</span> <span class="nn">iotbx.pdb.amino_acid_codes</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please specify one or more pdb file names.&quot;</span><span class="p">)</span>
  <span class="n">aa_resnames</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">amino_acid_codes</span><span class="o">.</span><span class="n">one_letter_given_three_letter</span>
  <span class="n">ala_atom_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot; N  &quot;</span><span class="p">,</span> <span class="s2">&quot; CA &quot;</span><span class="p">,</span> <span class="s2">&quot; C  &quot;</span><span class="p">,</span> <span class="s2">&quot; O  &quot;</span><span class="p">,</span> <span class="s2">&quot; CB &quot;</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
    <span class="n">pdb_obj</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">overall_counts</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">models</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residue_groups</span><span class="p">():</span>
          <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">resname</span> <span class="ow">in</span> <span class="n">aa_resnames</span><span class="p">):</span>
              <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ag</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ala_atom_names</span><span class="p">):</span>
                  <span class="n">ag</span><span class="o">.</span><span class="n">remove_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
    <span class="n">output_pdb</span> <span class="o">=</span> <span class="s2">&quot;v2_truncated_to_ala_&quot;</span><span class="o">+</span><span class="n">file_name</span>
    <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">write_pdb_file</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">output_pdb</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
  <span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
<p>The output PDB file of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">python</span> <span class="n">v2_simple</span><span class="o">.</span><span class="n">py</span> <span class="n">crambin_pieces</span><span class="o">.</span><span class="n">pdb</span>
</pre></div>
</div>
<p>can be found here:
<a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v2_truncated_to_ala_crambin_pieces.pdb">http://cctbx.sourceforge.net/sbgrid2008/v2_truncated_to_ala_crambin_pieces.pdb</a></p>
</section>
<section id="v3-better-py">
<h2><code class="docutils literal notranslate"><span class="pre">v3_better.py</span></code><a class="headerlink" href="#v3-better-py" title="Permalink to this headline">¶</a></h2>
<p>For most practical purposes, the <code class="docutils literal notranslate"><span class="pre">v2_simple.py</span></code> script is completely
sufficient. However, there are currently 16 files in the PDB (of 50623
total, as of Apr 30, 2008) for which this is not true. One example is
the structure with the PDB ID <code class="docutils literal notranslate"><span class="pre">1ysl</span></code>. The file <a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/resname_mix.pdb">resname_mix.pdb</a>
contains the problematic residue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HETATM</span> <span class="mi">3907</span>  <span class="n">N</span>  <span class="n">ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">25.006</span>  <span class="mf">36.731</span>  <span class="mf">16.222</span>  <span class="mf">0.50</span> <span class="mf">18.83</span>           <span class="n">N</span>
<span class="n">HETATM</span> <span class="mi">3908</span>  <span class="n">CA</span> <span class="n">ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">25.536</span>  <span class="mf">35.903</span>  <span class="mf">15.152</span>  <span class="mf">0.50</span> <span class="mf">19.90</span>           <span class="n">C</span>
<span class="n">HETATM</span> <span class="mi">3909</span>  <span class="n">CB</span> <span class="n">ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">25.931</span>  <span class="mf">36.658</span>  <span class="mf">13.876</span>  <span class="mf">0.50</span> <span class="mf">21.09</span>           <span class="n">C</span>
<span class="n">HETATM</span> <span class="mi">3910</span>  <span class="n">SG</span> <span class="n">ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">25.414</span>  <span class="mf">38.295</span>  <span class="mf">13.671</span>  <span class="mf">0.50</span> <span class="mf">26.29</span>           <span class="n">S</span>
<span class="n">HETATM</span> <span class="mi">3911</span>  <span class="n">C</span>  <span class="n">ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">26.713</span>  <span class="mf">35.054</span>  <span class="mf">15.562</span>  <span class="mf">0.50</span> <span class="mf">19.23</span>           <span class="n">C</span>
<span class="n">HETATM</span> <span class="mi">3912</span>  <span class="n">O</span>  <span class="n">ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">27.472</span>  <span class="mf">34.533</span>  <span class="mf">14.697</span>  <span class="mf">0.50</span> <span class="mf">20.10</span>           <span class="n">O</span>
<span class="n">HETATM</span> <span class="mi">3913</span>  <span class="n">OD1ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">23.793</span>  <span class="mf">38.008</span>  <span class="mf">13.181</span>  <span class="mf">0.50</span> <span class="mf">30.17</span>           <span class="n">O</span>
<span class="n">HETATM</span> <span class="mi">3914</span>  <span class="n">OD2ACSD</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">25.111</span>  <span class="mf">39.102</span>  <span class="mf">15.048</span>  <span class="mf">0.50</span> <span class="mf">26.06</span>           <span class="n">O</span>
<span class="n">ATOM</span>   <span class="mi">3915</span>  <span class="n">N</span>  <span class="n">BCYS</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">24.996</span>  <span class="mf">36.697</span>  <span class="mf">16.246</span>  <span class="mf">0.50</span> <span class="mf">13.39</span>           <span class="n">N</span>
<span class="n">ATOM</span>   <span class="mi">3916</span>  <span class="n">CA</span> <span class="n">BCYS</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">25.522</span>  <span class="mf">35.913</span>  <span class="mf">15.123</span>  <span class="mf">0.50</span> <span class="mf">16.53</span>           <span class="n">C</span>
<span class="n">ATOM</span>   <span class="mi">3917</span>  <span class="n">C</span>  <span class="n">BCYS</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">26.790</span>  <span class="mf">35.104</span>  <span class="mf">15.498</span>  <span class="mf">0.50</span> <span class="mf">15.20</span>           <span class="n">C</span>
<span class="n">ATOM</span>   <span class="mi">3918</span>  <span class="n">O</span>  <span class="n">BCYS</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">27.342</span>  <span class="mf">34.391</span>  <span class="mf">14.660</span>  <span class="mf">0.50</span> <span class="mf">16.26</span>           <span class="n">O</span>
<span class="n">ATOM</span>   <span class="mi">3919</span>  <span class="n">CB</span> <span class="n">BCYS</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">25.840</span>  <span class="mf">36.879</span>  <span class="mf">13.947</span>  <span class="mf">0.50</span> <span class="mf">20.05</span>           <span class="n">C</span>
<span class="n">ATOM</span>   <span class="mi">3920</span>  <span class="n">SG</span> <span class="n">BCYS</span> <span class="n">B</span> <span class="mi">111</span>      <span class="mf">24.645</span>  <span class="mf">38.257</span>  <span class="mf">14.039</span>  <span class="mf">0.50</span> <span class="mf">29.86</span>           <span class="n">S</span>
</pre></div>
</div>
<p>Rare cases like this are the very reason why we need the
<code class="docutils literal notranslate"><span class="pre">residue_group</span></code> and <code class="docutils literal notranslate"><span class="pre">atom_group</span></code> levels in the hierarchy. Here
we have two different residue names for the same member of a
chain. Even though this sitution is rare (there are only 37 additional
non-amino-acid instances in the PDB), they are entirely plausible and
valid, and a comprehensive PDB processing library has to be able to
handle them.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">v2_simple.py</span></code> script will only truncate the <code class="docutils literal notranslate"><span class="pre">CYS</span></code> residue
above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">python</span> <span class="n">v2_simple</span><span class="o">.</span><span class="n">py</span> <span class="n">resname_mix</span><span class="o">.</span><span class="n">pdb</span>
</pre></div>
</div>
<p>Output:
<a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v2_truncated_to_ala_resname_mix.pdb">http://cctbx.sourceforge.net/sbgrid2008/v2_truncated_to_ala_resname_mix.pdb</a></p>
<p>It would be better if it also truncated the non-standard <code class="docutils literal notranslate"><span class="pre">CSD</span></code>
residue in the <code class="docutils literal notranslate"><span class="pre">A</span></code> alternative conformation. Let’s find out what
it takes to achieve this.</p>
<p>The basic idea is to check if there is at least one amino acid in a
residue group, and if so, apply the truncation to all residues in the
group, even if they don’t have a standard residue name. This means,
for each residue group we have to loop over the atom groups twice,
first to scan for at least one standard amino-acid residue name,
and if there is one, a second time to do the truncation.
The bad news is, to achieve this, we have to double our effort.
The good news is, the extra effort is only five lines.</p>
<p>This is the part of <code class="docutils literal notranslate"><span class="pre">v2_simple.py</span></code> we have to work on:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">resname</span> <span class="ow">in</span> <span class="n">aa_resnames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ag</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ala_atom_names</span><span class="p">):</span>
        <span class="n">ag</span><span class="o">.</span><span class="n">remove_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
</pre></div>
</div>
<p>The extra effort goes into finding out if there is at least
one amino acid in the residue group:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">have_amino_acid</span><span class="p">():</span>
  <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">resname</span> <span class="ow">in</span> <span class="n">aa_resnames</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">True</span>
  <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Once that’s settled, we can move the
<code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(ag.resname</span> <span class="pre">in</span> <span class="pre">aa_resnames)</span></code> test outside the loop
over the atom groups and replace it with <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(have_amino_acid())</span></code>.
The rest of the v2 code is unchanged:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">have_amino_acid</span><span class="p">()):</span>
  <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ag</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ala_atom_names</span><span class="p">):</span>
        <span class="n">ag</span><span class="o">.</span><span class="n">remove_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">have_amino_acid()</span></code> is a nested function. Nested functions
are often very useful to centralize small sub-tasks without taking
them completely out of context. Since our nested function is aware
of the context, we don’t need to pass any arguments.</p>
<p>The complete source for this script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">iotbx.pdb</span>
<span class="kn">import</span> <span class="nn">iotbx.pdb.amino_acid_codes</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please specify one or more pdb file names.&quot;</span><span class="p">)</span>
  <span class="n">aa_resnames</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">amino_acid_codes</span><span class="o">.</span><span class="n">one_letter_given_three_letter</span>
  <span class="n">ala_atom_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot; N  &quot;</span><span class="p">,</span> <span class="s2">&quot; CA &quot;</span><span class="p">,</span> <span class="s2">&quot; C  &quot;</span><span class="p">,</span> <span class="s2">&quot; O  &quot;</span><span class="p">,</span> <span class="s2">&quot; CB &quot;</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
    <span class="n">pdb_obj</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">overall_counts</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">models</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residue_groups</span><span class="p">():</span>
          <span class="k">def</span> <span class="nf">have_amino_acid</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">resname</span> <span class="ow">in</span> <span class="n">aa_resnames</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">have_amino_acid</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
              <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ag</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ala_atom_names</span><span class="p">):</span>
                  <span class="n">ag</span><span class="o">.</span><span class="n">remove_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
    <span class="n">output_pdb</span> <span class="o">=</span> <span class="s2">&quot;v3_truncated_to_ala_&quot;</span><span class="o">+</span><span class="n">file_name</span>
    <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">write_pdb_file</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">output_pdb</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
  <span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
<p>The output PDB file of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">python</span> <span class="n">v3_better</span><span class="o">.</span><span class="n">py</span> <span class="n">resname_mix</span><span class="o">.</span><span class="n">pdb</span>
</pre></div>
</div>
<p>can be found here:
<a class="reference external" href="http://cctbx.sourceforge.net/sbgrid2008/v3_truncated_to_ala_resname_mix.pdb">http://cctbx.sourceforge.net/sbgrid2008/v3_truncated_to_ala_resname_mix.pdb</a></p>
</section>
<section id="v4-with-bells-and-whistles-py">
<h2><code class="docutils literal notranslate"><span class="pre">v4_with_bells_and_whistles.py</span></code><a class="headerlink" href="#v4-with-bells-and-whistles-py" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">v3_better.py</span></code> script does a comprehensive job, but it
doesn’t tell the user anything about the manipulations. It would
be interesting to know how many atoms were deleted, how many
residue are affected, and how many residue are unchanged. The
<code class="docutils literal notranslate"><span class="pre">v4_with_bells_and_whistles.py</span></code> script produces this information.</p>
<p>To get the desired counts, we need counters, and we need to initialize
them before we enter the nested loops over the hierarchy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_amino_acid_residues</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">n_other_residues</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">n_atoms_removed</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">n</span></code> is a shorthand for <em>number of</em>.
Inside the loop over the residue groups, we keep track of the
amino-acid counts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">have_amino_acid</span><span class="p">()):</span>
  <span class="n">n_other_residues</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">n_amino_acid_residues</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>And instead of just removing the atoms, we remove and count:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ag</span><span class="o">.</span><span class="n">remove_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
<span class="n">n_atoms_removed</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>When the loops over the hierarchy are finished, we print the counts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s2">&quot;Number of amino acid residues:&quot;</span><span class="p">,</span> <span class="n">n_amino_acid_residues</span>
<span class="nb">print</span> <span class="s2">&quot;Number of other residues:&quot;</span><span class="p">,</span> <span class="n">n_other_residues</span>
<span class="nb">print</span> <span class="s2">&quot;Number of atoms removed:&quot;</span><span class="p">,</span> <span class="n">n_atoms_removed</span>
</pre></div>
</div>
<p>Since we can now easily find out if no atoms were removed (e.g. because
someone passed in a DNA model), we should take advantage of it and
write the output PDB file only if there are changes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">n_atoms_removed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
  <span class="n">output_pdb</span> <span class="o">=</span> <span class="s2">&quot;v4_truncated_to_ala_&quot;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">output_pdb</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)):</span> <span class="n">output_pdb</span> <span class="o">=</span> <span class="n">output_pdb</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
  <span class="nb">print</span> <span class="s2">&quot;Writing file:&quot;</span><span class="p">,</span> <span class="n">output_pdb</span>
  <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">write_pdb_file</span><span class="p">(</span>
    <span class="n">file_name</span><span class="o">=</span><span class="n">output_pdb</span><span class="p">,</span>
    <span class="n">crystal_symmetry</span><span class="o">=</span><span class="n">pdb_obj</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">(),</span>
    <span class="n">append_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>There are three more small enhancements compared to the
<code class="docutils literal notranslate"><span class="pre">v3_better.py</span></code> script:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">os.path.basename()</span></code> is used to remove any directory name
component from the input file name, if present. With this,
it is certain that the output file is written in the current
working directory, not the directory of the input file (which
may be in another user’s directory or a system directory)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">iotbx.pdb.hierarchy.input</span></code> is able to open <cite>.gz</cite> files
directly (e.g. compressed files as downloaded from the PDB).
However, the <code class="docutils literal notranslate"><span class="pre">.write_pdb_file()</span></code> method always writes plain
(non-compressed) files. Therefore the <code class="docutils literal notranslate"><span class="pre">.gz</span></code> extension has to be
removed, if present. The string method <code class="docutils literal notranslate"><span class="pre">.endswith()</span></code> is used to
detect the extension, and string slicing (<code class="docutils literal notranslate"><span class="pre">[:-3]</span></code>) to remove it.</p></li>
<li><p>The input crystal symmetry information (unit cell and space group)
is passed to the <code class="docutils literal notranslate"><span class="pre">.write_pdb_file()</span></code> method, which then
writes CRYST1 and SCALE records to the output file. In addtion,
the optional <code class="docutils literal notranslate"><span class="pre">append_end</span></code> argument is used to request that
an END record is written at the end of the output file.</p></li>
</ul>
</div></blockquote>
<p>Full source:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">iotbx.pdb</span>
<span class="kn">import</span> <span class="nn">iotbx.pdb.amino_acid_codes</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please specify one or more pdb file names.&quot;</span><span class="p">)</span>
  <span class="n">aa_resnames</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">amino_acid_codes</span><span class="o">.</span><span class="n">one_letter_given_three_letter</span>
  <span class="n">ala_atom_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot; N  &quot;</span><span class="p">,</span> <span class="s2">&quot; CA &quot;</span><span class="p">,</span> <span class="s2">&quot; C  &quot;</span><span class="p">,</span> <span class="s2">&quot; O  &quot;</span><span class="p">,</span> <span class="s2">&quot; CB &quot;</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
    <span class="n">pdb_obj</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">overall_counts</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">n_amino_acid_residues</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_other_residues</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_atoms_removed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">models</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">chains</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residue_groups</span><span class="p">():</span>
          <span class="k">def</span> <span class="nf">have_amino_acid</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">resname</span> <span class="ow">in</span> <span class="n">aa_resnames</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
          <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">have_amino_acid</span><span class="p">()):</span>
            <span class="n">n_other_residues</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">n_amino_acid_residues</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">rg</span><span class="o">.</span><span class="n">atom_groups</span><span class="p">():</span>
              <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ag</span><span class="o">.</span><span class="n">atoms</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ala_atom_names</span><span class="p">):</span>
                  <span class="n">ag</span><span class="o">.</span><span class="n">remove_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
                  <span class="n">n_atoms_removed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Number of amino acid residues:&quot;</span><span class="p">,</span> <span class="n">n_amino_acid_residues</span>
    <span class="nb">print</span> <span class="s2">&quot;Number of other residues:&quot;</span><span class="p">,</span> <span class="n">n_other_residues</span>
    <span class="nb">print</span> <span class="s2">&quot;Number of atoms removed:&quot;</span><span class="p">,</span> <span class="n">n_atoms_removed</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n_atoms_removed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
      <span class="n">output_pdb</span> <span class="o">=</span> <span class="s2">&quot;v4_truncated_to_ala_&quot;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">output_pdb</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)):</span> <span class="n">output_pdb</span> <span class="o">=</span> <span class="n">output_pdb</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
      <span class="nb">print</span> <span class="s2">&quot;Writing file:&quot;</span><span class="p">,</span> <span class="n">output_pdb</span>
      <span class="n">pdb_obj</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">write_pdb_file</span><span class="p">(</span>
        <span class="n">file_name</span><span class="o">=</span><span class="n">output_pdb</span><span class="p">,</span>
        <span class="n">crystal_symmetry</span><span class="o">=</span><span class="n">pdb_obj</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">(),</span>
        <span class="n">append_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span>

<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
  <span class="n">run</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
</section>
<section id="source-and-pdb-files">
<h2>Source and PDB files<a class="headerlink" href="#source-and-pdb-files" title="Permalink to this headline">¶</a></h2>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">iotbx.pdb tutorial: <code class="docutils literal notranslate"><span class="pre">pdb_truncate_to_ala</span></code></a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#use-print-and-help">Use print and help()!</a></li>
<li><a class="reference internal" href="#v0-getting-started-py"><code class="docutils literal notranslate"><span class="pre">v0_getting_started.py</span></code></a></li>
<li><a class="reference internal" href="#v1-loop-over-atoms-py"><code class="docutils literal notranslate"><span class="pre">v1_loop_over_atoms.py</span></code></a></li>
<li><a class="reference internal" href="#v2-simple-py"><code class="docutils literal notranslate"><span class="pre">v2_simple.py</span></code></a></li>
<li><a class="reference internal" href="#v3-better-py"><code class="docutils literal notranslate"><span class="pre">v3_better.py</span></code></a></li>
<li><a class="reference internal" href="#v4-with-bells-and-whistles-py"><code class="docutils literal notranslate"><span class="pre">v4_with_bells_and_whistles.py</span></code></a></li>
<li><a class="reference internal" href="#source-and-pdb-files">Source and PDB files</a></li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/iotbx/iotbx.pdb_tutorial.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CCTBX Developer documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">iotbx.pdb tutorial: <code class="docutils literal notranslate"><span class="pre">pdb_truncate_to_ala</span></code></a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, University of California.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>