
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>libtbx.phil - Python-based hierarchical interchange language &#8212; CCTBX Developer documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="libtbx.easy_mp: functions for painless parallelization of Python code" href="libtbx.easy_mp.html" />
    <link rel="prev" title="libtbx - low-level utilities and infrastructure for CCTBX" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="libtbx.easy_mp.html" title="libtbx.easy_mp: functions for painless parallelization of Python code"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="libtbx - low-level utilities and infrastructure for CCTBX"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CCTBX Developer documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">libtbx - low-level utilities and infrastructure for CCTBX</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">libtbx.phil - Python-based hierarchical interchange language</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="libtbx-phil-python-based-hierarchical-interchange-language">
<h1><a class="toc-backref" href="#id1">libtbx.phil - Python-based hierarchical interchange language</a><a class="headerlink" href="#libtbx-phil-python-based-hierarchical-interchange-language" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Ralf W. Grosse-Kunstleve</p>
</dd>
</dl>
<div class="contents topic" id="sections">
<p class="topic-title">Sections</p>
<ul class="simple">
<li><p><a class="reference internal" href="#libtbx-phil-python-based-hierarchical-interchange-language" id="id1">libtbx.phil - Python-based hierarchical interchange language</a></p>
<ul>
<li><p><a class="reference internal" href="#phil-overview" id="id2">Phil overview</a></p></li>
<li><p><a class="reference internal" href="#beyond-syntax" id="id3">Beyond syntax</a></p></li>
<li><p><a class="reference internal" href="#master-files" id="id4">Master files</a></p></li>
<li><p><a class="reference internal" href="#user-files" id="id5">User files</a></p></li>
<li><p><a class="reference internal" href="#command-line-arguments" id="id6">Command-line arguments</a></p></li>
<li><p><a class="reference internal" href="#fetch-merging-of-phil-objects" id="id7">fetch: merging of Phil objects</a></p></li>
<li><p><a class="reference internal" href="#extract-conversion-of-phil-objects-to-python-objects" id="id8">extract: conversion of Phil objects to Python objects</a></p></li>
<li><p><a class="reference internal" href="#format-conversion-of-python-objects-to-phil-objects" id="id9">format: conversion of Python objects to Phil objects</a></p></li>
<li><p><a class="reference internal" href="#multiple-true" id="id10">.multiple = True</a></p></li>
<li><p><a class="reference internal" href="#fetch-diff-difference-between-master-phil-and-working-phil" id="id11">fetch_diff: difference between master_phil and working_phil</a></p></li>
<li><p><a class="reference internal" href="#includes" id="id12">Includes</a></p></li>
<li><p><a class="reference internal" href="#variable-substitution" id="id13">Variable substitution</a></p></li>
<li><p><a class="reference internal" href="#extending-phil" id="id14">Extending Phil</a></p></li>
<li><p><a class="reference internal" href="#details" id="id15">Details</a></p>
<ul>
<li><p><a class="reference internal" href="#type-ints-and-type-floats" id="id16">.type = ints and .type = floats</a></p></li>
<li><p><a class="reference internal" href="#type-choice" id="id17">.type = choice</a></p></li>
<li><p><a class="reference internal" href="#scope-extract" id="id18">scope_extract</a></p></li>
<li><p><a class="reference internal" href="#multiple-definitions-and-scopes" id="id19">Multiple definitions and scopes</a></p></li>
<li><p><a class="reference internal" href="#fetch-option-track-unused-definitions" id="id20">fetch option: track_unused_definitions</a></p></li>
<li><p><a class="reference internal" href="#semicolon-syntax" id="id21">Semicolon syntax</a></p></li>
<li><p><a class="reference internal" href="#phil-comments" id="id22">Phil comments</a></p></li>
<li><p><a class="reference internal" href="#quotes-and-backslash" id="id23">Quotes and backslash</a></p></li>
<li><p><a class="reference internal" href="#scope-show-attributes-level-3" id="id24">scope.show(attributes_level=3)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#api-documentation-for-phil-definition" id="id25">API documentation for PHIL definition</a></p></li>
<li><p><a class="reference internal" href="#api-documentation-for-phil-scope" id="id26">API documentation for PHIL scope</a></p></li>
<li><p><a class="reference internal" href="#module-libtbx.phil.command_line" id="id27">Command-line input</a></p></li>
</ul>
</li>
</ul>
</div>
<p><strong>Links</strong></p>
<dl class="simple">
<dt>The primary home of this document is:</dt><dd><p><a class="reference external" href="https://cctbx.github.io/libtbx/libtbx.phil.html">https://cctbx.github.io/libtbx/libtbx.phil.html</a></p>
</dd>
<dt>The source code examples below are available as one file here:</dt><dd><p><a class="reference external" href="https://github.com/cctbx/cctbx_project/blob/master/iotbx/examples/libtbx_phil_examples.py">https://github.com/cctbx/cctbx_project/blob/master/iotbx/examples/libtbx_phil_examples.py</a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">libtbx.phil</span></code> is part of the cctbx open source libraries:</dt><dd><p><a class="reference external" href="https://github.com/cctbx/cctbx_project">https://github.com/cctbx/cctbx_project</a></p>
</dd>
</dl>
<div class="section" id="phil-overview">
<h2><a class="toc-backref" href="#id2">Phil overview</a><a class="headerlink" href="#phil-overview" title="Permalink to this headline">¶</a></h2>
<p>Phil (Python-based hierarchical interchange language) is a module
for the management of application parameters and, to some degree,
inputs. Many applications use command-line options as a user interface
(e.g. based on Python’s optparse, a.k.a Optik). This approach works
well for small applications, but has it limitations for more complex
applications with a large set of parameters.</p>
<p>A simple Phil file as presented to the user may look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span> <span class="p">{</span>
  <span class="n">file_name</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">dat</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">set2</span>
<span class="p">}</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">output</span> <span class="p">{</span>
  <span class="n">model_file</span> <span class="o">=</span> <span class="n">final</span><span class="o">.</span><span class="n">mdl</span>
  <span class="n">plot_file</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">}</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span> <span class="p">{</span>
  <span class="n">method</span> <span class="o">=</span> <span class="o">*</span><span class="n">bfgs</span> <span class="n">conjugate_gradient</span>
  <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Phil is designed with a minimal syntax. An important goal is to
enable users to get started just by looking at defaults and examples,
without having to read documentation.</p>
<p>The Phil syntax has only two main elements, <code class="docutils literal notranslate"><span class="pre">phil.definition</span></code> (e.g.
<code class="docutils literal notranslate"><span class="pre">max_iterations</span> <span class="pre">=</span> <span class="pre">10</span></code> and <code class="docutils literal notranslate"><span class="pre">phil.scope</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">minimization.input</span> <span class="pre">{</span> <span class="pre">}</span></code>).
To make this syntax as user-friendly as possible, strings
do not have to be quoted and, unlike Python, indentation is not
syntactically significant. E.g. this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span> <span class="p">{</span>
<span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;experiment.dat&quot;</span>
<span class="n">labels</span><span class="o">=</span><span class="s2">&quot;set2&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>is equivalent to the corresponding definitions above.</p>
<p>Scopes can be nested recursively. The number of nesting levels is
limited only by Python’s recursion limit (default 1000). To maximize
convenience, nested scopes can be defined in two equivalent ways.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span> <span class="p">{</span>
  <span class="nb">input</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="beyond-syntax">
<h2><a class="toc-backref" href="#id3">Beyond syntax</a><a class="headerlink" href="#beyond-syntax" title="Permalink to this headline">¶</a></h2>
<p>Phil is much more than just a parser for a very simple, user-friendly
syntax. Major Phil features are:</p>
<blockquote>
<div><ul class="simple">
<li><p>The concepts of <cite>master files</cite> and <cite>user files</cite>. The syntax
for the two types of Phil files is identical, but the processed
Phil files are used in different ways. I.e. the concepts exist
only at the semantical level. The “look and feel” of the files is
uniform.</p></li>
<li><p>Interpretation of command-line arguments as Phil definitions.</p></li>
<li><p>Merging of (multiple) Phil files and (multiple) Phil definitions
derived from command-line arguments.</p></li>
<li><p>Automatic conversion of Phil files to Python objects
which are essentially independent of the Phil system. I.e.
core algorithms using Phil-derived parameter objects do not
actually have to depend on Phil.</p></li>
<li><p>The reverse conversion of (potentially modified) Python
objects back to Phil files. This could also be viewed as a Phil
pretty printer.</p></li>
<li><p>Shell-like variable substitution using $var and ${var} syntax.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">include</span></code> syntax to merge Phil files at the parser level,
or to import Phil objects from other Python scripts.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="master-files">
<h2><a class="toc-backref" href="#id4">Master files</a><a class="headerlink" href="#master-files" title="Permalink to this headline">¶</a></h2>
<p>Master files are written by the software developer and include
“attributes” for each parameter, such as the type (integer,
floating-point, string, etc.) and support information for graphical
interfaces. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span>
  <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Selection and tuning of minimization algorithm.&quot;</span>
  <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">{</span>
  <span class="n">method</span> <span class="o">=</span> <span class="o">*</span><span class="n">bfgs</span> <span class="n">conjugate_gradient</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">choice</span>
  <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The is the last part of the output of this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">some</span><span class="o">-</span><span class="n">attributes</span> <span class="n">example</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
<p>Run this command with <code class="docutils literal notranslate"><span class="pre">--show-all-attributes</span></code> to see the full set
of <code class="docutils literal notranslate"><span class="pre">definition</span></code> and <code class="docutils literal notranslate"><span class="pre">scope</span></code> attributes. This output tends to get
very long, but end-users don’t have to be aware of this, and even
programmers only have to deal with the attributes they want to change.</p>
</div>
<div class="section" id="user-files">
<h2><a class="toc-backref" href="#id5">User files</a><a class="headerlink" href="#user-files" title="Permalink to this headline">¶</a></h2>
<p>User files are typically generated by the application. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">quick</span> <span class="o">--</span><span class="n">show_defaults</span>
</pre></div>
</div>
<p>will process its master file and show only the most
relevant parameters, classified by the software developer as
<code class="docutils literal notranslate"><span class="pre">.expert_level</span> <span class="pre">=</span> <span class="pre">0</span></code> (default). E.g. the <code class="docutils literal notranslate"><span class="pre">minimization.parameters</span></code>
scope in the example above is not shown. The attributes are also
not shown. Therefore the output is much shorter compared to the
<code class="docutils literal notranslate"><span class="pre">libtbx.phil</span> <span class="pre">--show-some-attributes</span></code> output above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span> <span class="p">{</span>
  <span class="n">method</span> <span class="o">=</span> <span class="o">*</span><span class="n">bfgs</span> <span class="n">conjugate_gradient</span>
  <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-arguments">
<h2><a class="toc-backref" href="#id6">Command-line arguments</a><a class="headerlink" href="#command-line-arguments" title="Permalink to this headline">¶</a></h2>
<p>In theory the user could save and edit the generated parameter files.
However, in many practical situations this manual step can be
avoided. Phil is designed with the idea that the application inspects
all input files and uses the information found to fill in the blanks
automatically. This is not only convenient, but also eliminates
the possiblity of typing errors. In addition, the user can specify
parameters directly on the command line, and this information is also
use to fill in the blanks.</p>
<p>Command-line arguments that are not file names or options prefixed
with <code class="docutils literal notranslate"><span class="pre">--</span></code> (like <code class="docutils literal notranslate"><span class="pre">--show_defaults</span></code> above) should be given to Phil
for examination. E.g., this is a possible command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">quick</span> <span class="n">experiment</span><span class="o">.</span><span class="n">dat</span> <span class="n">output</span><span class="o">.</span><span class="n">plot_file</span><span class="o">=</span><span class="n">plot</span><span class="o">.</span><span class="n">pdf</span>
</pre></div>
</div>
<p>First the application should check if an argument is the name of a
file that can be opened. Assume this succeeds for the first argument,
so the processing of this argument is finished. Assume further that a
file with the name <code class="docutils literal notranslate"><span class="pre">output.plot_file=plot.pdf</span></code> does not exist. This
argument will therefore be interpreted with Phil. The next section
presents an example.</p>
</div>
<div class="section" id="fetch-merging-of-phil-objects">
<h2><a class="toc-backref" href="#id7">fetch: merging of Phil objects</a><a class="headerlink" href="#fetch-merging-of-phil-objects" title="Permalink to this headline">¶</a></h2>
<p>The Phil parser converts master files, user files and command line
arguments to uniform Phil objects which can be merged to generate a
combined set of “working” parameters used in running the application.
We demonstrate this by way of a simple, self-contained Python script
with embedded Phil syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="kn">from</span> <span class="nn">libtbx.phil</span> <span class="kn">import</span> <span class="n">parse</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.input {</span>
<span class="s2">    file_name = None</span>
<span class="s2">      .type = path</span>
<span class="s2">    label = None</span>
<span class="s2">      .type = str</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.input {</span>
<span class="s2">    file_name = experiment.dat</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">command_line_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span>
  <span class="s2">&quot;minimization.input.label=set2&quot;</span><span class="p">)</span>

<span class="n">working_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
  <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">user_phil</span><span class="p">,</span> <span class="n">command_line_phil</span><span class="p">])</span>
<span class="n">working_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">master_phil</span></code> defines all available parameters including the
type information. <code class="docutils literal notranslate"><span class="pre">user_phil</span></code> overrides the default <code class="docutils literal notranslate"><span class="pre">file_name</span></code>
assignment but leaves the <code class="docutils literal notranslate"><span class="pre">labels</span></code> undefined. These are defined
by a (fake) command-line argument. All inputs are merged via
<code class="docutils literal notranslate"><span class="pre">master_phil.fetch()</span></code>. <code class="docutils literal notranslate"><span class="pre">working_phil.show()</span></code> produces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span> <span class="p">{</span>
  <span class="n">file_name</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">dat</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">set2</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Having to type in fully qualified parameter names (e.g.
<code class="docutils literal notranslate"><span class="pre">minimization.input.labels</span></code>) can be very inconvenient. Therefore
Phil includes support for matching parameter names of command-line
arguments as substrings to the parameter names in the master files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">argument_interpreter</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">command_line_argument_interpreter</span><span class="p">(</span>
  <span class="n">home_scope</span><span class="o">=</span><span class="s2">&quot;minimization&quot;</span><span class="p">)</span>

<span class="n">command_line_phil</span> <span class="o">=</span> <span class="n">argument_interpreter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
  <span class="n">arg</span><span class="o">=</span><span class="s2">&quot;minimization.input.label=set2&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>This works even if the user writes just <code class="docutils literal notranslate"><span class="pre">label=set2</span></code> or even
<code class="docutils literal notranslate"><span class="pre">put.lab=x1</span> <span class="pre">x2</span></code>. The only requirement is that the substring leads
to a unique match in the master file. Otherwise Phil produces a helpful
error message. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">argument_interpreter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s2">&quot;a=set2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>leads to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sorry</span><span class="p">:</span> <span class="n">Ambiguous</span> <span class="n">parameter</span> <span class="n">definition</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="n">set2</span>
<span class="n">Best</span> <span class="n">matches</span><span class="p">:</span>
  <span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">file_name</span>
  <span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">label</span>
</pre></div>
</div>
<p>The user can cut-and-paste the desired parameter into the command
line for another trial to run the application.</p>
</div>
<div class="section" id="extract-conversion-of-phil-objects-to-python-objects">
<h2><a class="toc-backref" href="#id8">extract: conversion of Phil objects to Python objects</a><a class="headerlink" href="#extract-conversion-of-phil-objects-to-python-objects" title="Permalink to this headline">¶</a></h2>
<p>The Phil parser produces objects that preserve most information
generated in the parsing process, such as line numbers and parameter
attributes. While this information is very useful for pretty printing
(e.g. to archive the working parameters) and the automatic generation
of graphical user interfaces, it is only a burden in the context of
core algorithms. Therefore Phil supports “extraction” of light-weight
Python objects from the Phil objects. Based on the example above,
this can be achieved with just one line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_params</span> <span class="o">=</span> <span class="n">working_phil</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>We can now use the extracted objects in the context of Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">file_name</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">label</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">experiment</span><span class="o">.</span><span class="n">dat</span>
<span class="n">set2</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">file_name</span></code> and <code class="docutils literal notranslate"><span class="pre">label</span></code> are now a simple Python strings.</p>
</div>
<div class="section" id="format-conversion-of-python-objects-to-phil-objects">
<h2><a class="toc-backref" href="#id9">format: conversion of Python objects to Phil objects</a><a class="headerlink" href="#format-conversion-of-python-objects-to-phil-objects" title="Permalink to this headline">¶</a></h2>
<p>Phil also supports the reverse conversion compared to the
previous section, from Python objects to Phil objects. For
example, to change the label:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;set3&quot;</span>
<span class="n">modified_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">python_object</span><span class="o">=</span><span class="n">working_params</span><span class="p">)</span>
<span class="n">modified_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span> <span class="p">{</span>
  <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;experiment.dat&quot;</span>
  <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;set3&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We need to bring in <code class="docutils literal notranslate"><span class="pre">master_phil</span></code> again because all the meta
information was lost in the <code class="docutils literal notranslate"><span class="pre">working_phil.extract()</span></code> step that
produced <code class="docutils literal notranslate"><span class="pre">working_params</span></code>. A type-specific converter is used to
produce a string for each Python object (see the Extending Phil
section below).</p>
</div>
<div class="section" id="multiple-true">
<h2><a class="toc-backref" href="#id10">.multiple = True</a><a class="headerlink" href="#multiple-true" title="Permalink to this headline">¶</a></h2>
<p>Both <code class="docutils literal notranslate"><span class="pre">phil.definition</span></code> and <code class="docutils literal notranslate"><span class="pre">phil.scope</span></code> support the <code class="docutils literal notranslate"><span class="pre">.multiple</span>
<span class="pre">=</span> <span class="pre">True</span></code> attribute. For the sake of simplicity, in the following
“multiple definition” and “multiple scope” means a master definition or
scope with <code class="docutils literal notranslate"><span class="pre">.multiple</span> <span class="pre">=</span> <span class="pre">True</span></code>. Please note the distinction between
this and multiple <em>values</em> given in a user file. For example, this
is a multiple definition in a master file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.input {</span>
<span class="s2">    file_name = None</span>
<span class="s2">      .type = path</span>
<span class="s2">      .multiple = True</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>And these are multiple values for this definition in a user file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.input {</span>
<span class="s2">    file_name = experiment1.dat</span>
<span class="s2">    file_name = experiment2.dat</span>
<span class="s2">    file_name = experiment3.dat</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>I.e. multiple values are simply specified by repeated definitions.
Without the <code class="docutils literal notranslate"><span class="pre">.multiple</span> <span class="pre">=</span> <span class="pre">True</span></code> in the master file, <code class="docutils literal notranslate"><span class="pre">.fetch()</span></code>
retains only the <em>last</em> definition found in the master and all user
files or command-line arguments. <code class="docutils literal notranslate"><span class="pre">.multiple</span> <span class="pre">=</span> <span class="pre">True</span></code> directs Phil
to keep all values. <code class="docutils literal notranslate"><span class="pre">.extract()</span></code> then returns a list of all these
values converted to Python objects. For example, given the user
file above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">file_name</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>will show this Python list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;experiment1.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment2.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment3.dat&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Multiple scopes work similarly, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization {</span>
<span class="s2">    input</span>
<span class="s2">      .multiple = True</span>
<span class="s2">    {</span>
<span class="s2">      file_name = None</span>
<span class="s2">        .type = path</span>
<span class="s2">      label = None</span>
<span class="s2">        .type = str</span>
<span class="s2">    }</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>A corresponding user file may look this this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization {</span>
<span class="s2">    input {</span>
<span class="s2">      file_name = experiment1.dat</span>
<span class="s2">      label = set2</span>
<span class="s2">    }</span>
<span class="s2">    input {</span>
<span class="s2">      file_name = experiment2.dat</span>
<span class="s2">      label = set1</span>
<span class="s2">    }</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>The result of the usual fetch-extract sequence is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
  <span class="nb">print</span> <span class="nb">input</span><span class="o">.</span><span class="n">file_name</span>
  <span class="nb">print</span> <span class="nb">input</span><span class="o">.</span><span class="n">label</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">experiment1</span><span class="o">.</span><span class="n">dat</span>
<span class="n">set2</span>
<span class="n">experiment2</span><span class="o">.</span><span class="n">dat</span>
<span class="n">set1</span>
</pre></div>
</div>
<p>Definitions and scopes may be nested with any combination of
<code class="docutils literal notranslate"><span class="pre">.multiple</span> <span class="pre">=</span> <span class="pre">False</span></code> or <code class="docutils literal notranslate"><span class="pre">.multiple</span> <span class="pre">=</span> <span class="pre">True</span></code>. For example, this
would be a plausible master file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization {</span>
<span class="s2">    input</span>
<span class="s2">      .multiple = True</span>
<span class="s2">    {</span>
<span class="s2">      file_name = None</span>
<span class="s2">        .type = path</span>
<span class="s2">      label = None</span>
<span class="s2">        .type = str</span>
<span class="s2">        .multiple = True</span>
<span class="s2">    }</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>This is a possible corresponding user file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization {</span>
<span class="s2">    input {</span>
<span class="s2">      file_name = experiment1.dat</span>
<span class="s2">      label = set1</span>
<span class="s2">      label = set2</span>
<span class="s2">      label = set3</span>
<span class="s2">    }</span>
<span class="s2">    input {</span>
<span class="s2">      file_name = experiment2.dat</span>
<span class="s2">      label = set2</span>
<span class="s2">      label = set3</span>
<span class="s2">    }</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>The fetch-extract sequence is the same as before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
  <span class="nb">print</span> <span class="nb">input</span><span class="o">.</span><span class="n">file_name</span>
  <span class="nb">print</span> <span class="nb">input</span><span class="o">.</span><span class="n">label</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>but the output shows lists of strings for <code class="docutils literal notranslate"><span class="pre">label</span></code> instead of just
one Python string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">experiment1</span><span class="o">.</span><span class="n">dat</span>
<span class="p">[</span><span class="s1">&#39;set1&#39;</span><span class="p">,</span> <span class="s1">&#39;set2&#39;</span><span class="p">,</span> <span class="s1">&#39;set3&#39;</span><span class="p">]</span>
<span class="n">experiment2</span><span class="o">.</span><span class="n">dat</span>
<span class="p">[</span><span class="s1">&#39;set2&#39;</span><span class="p">,</span> <span class="s1">&#39;set3&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="fetch-diff-difference-between-master-phil-and-working-phil">
<h2><a class="toc-backref" href="#id11">fetch_diff: difference between master_phil and working_phil</a><a class="headerlink" href="#fetch-diff-difference-between-master-phil-and-working-phil" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">.fetch()</span></code> method introduced above produces a complete copy
of the Phil master with all user definitions and scopes merged in.
If the Phil master is large, the output of <code class="docutils literal notranslate"><span class="pre">working_phil.show()</span></code> will
therefore also be large. It may be difficult to see which definitions
still have default values, and which definitions are changed.
To get just the difference between the master and the working
Phil objects, the <code class="docutils literal notranslate"><span class="pre">.fetch_diff()</span></code> method is available. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.parameters {</span>
<span class="s2">    method = *bfgs conjugate_gradient</span>
<span class="s2">      .type = choice</span>
<span class="s2">    max_iterations = 10</span>
<span class="s2">      .type = int</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.parameters {</span>
<span class="s2">    method = bfgs *conjugate_gradient</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">working_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span>
<span class="n">diff_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch_diff</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">working_phil</span><span class="p">)</span>
<span class="n">diff_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span> <span class="p">{</span>
  <span class="n">method</span> <span class="o">=</span> <span class="n">bfgs</span> <span class="o">*</span><span class="n">conjugate_gradient</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here the minimization method was changed from <code class="docutils literal notranslate"><span class="pre">bfgs</span></code>
to <code class="docutils literal notranslate"><span class="pre">conjugate_gradient</span></code> but the number of iterations is
unchanged. Therefore the latter does not appear in the output.
<code class="docutils literal notranslate"><span class="pre">.fetch_diff()</span></code> is completely general and works for any combination
of definitions and scopes with <code class="docutils literal notranslate"><span class="pre">.multiple</span> <span class="pre">=</span> <span class="pre">False</span></code> or <code class="docutils literal notranslate"><span class="pre">.multiple</span>
<span class="pre">=</span> <span class="pre">True</span></code>.</p>
</div>
<div class="section" id="includes">
<h2><a class="toc-backref" href="#id12">Includes</a><a class="headerlink" href="#includes" title="Permalink to this headline">¶</a></h2>
<p>Phil also supports merging of files at the parsing level. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="n">file</span> <span class="n">general</span><span class="o">.</span><span class="n">params</span>

<span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span> <span class="p">{</span>
  <span class="n">include</span> <span class="n">file</span> <span class="n">specific</span><span class="o">.</span><span class="n">params</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another option for building master files from a library of building
blocks is based on Python’s import mechanism. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="n">file</span> <span class="n">general</span><span class="o">.</span><span class="n">params</span>

<span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span> <span class="p">{</span>
  <span class="n">include</span> <span class="n">scope</span> <span class="n">app</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">master_phil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When encountering the <code class="docutils literal notranslate"><span class="pre">include</span> <span class="pre">scope</span></code>, the Phil parser automatically
imports <code class="docutils literal notranslate"><span class="pre">app.module</span></code> (equivalent to <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">app.module</span></code> in a Python
script). The <code class="docutils literal notranslate"><span class="pre">master_phil</span></code> object in the imported module must be
a pre-parsed Phil scope or a plain Phil string. The content of the
<code class="docutils literal notranslate"><span class="pre">master_phil</span></code> scope is inserted into the scope of the <code class="docutils literal notranslate"><span class="pre">include</span>
<span class="pre">scope</span></code> statement.</p>
<p><code class="docutils literal notranslate"><span class="pre">include</span></code> directives enable hierarchical building of
master files without the need to copy-and-paste large fragments
explicitly. Duplication appears only in automatically generated user
files. I.e. the programmer is well served because a system of master
files can be kept free of large-scale redundancies that are difficult
to maintain. At the same time the end user is well served because
the indirections are resolved automatically and all parameters are
presented in one uniform view.</p>
</div>
<div class="section" id="variable-substitution">
<h2><a class="toc-backref" href="#id13">Variable substitution</a><a class="headerlink" href="#variable-substitution" title="Permalink to this headline">¶</a></h2>
<p>Phil supports variable substitution using $var and $(var)
syntax. A few examples say more than many words:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">var_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  root_name = peak</span>
<span class="s2">  file_name = $root_name.mtz</span>
<span class="s2">  full_path = $HOME/$file_name</span>
<span class="s2">  related_file_name = $(root_name)_data.mtz</span>
<span class="s2">  message = &quot;Reading $file_name&quot;</span>
<span class="s2">  as_is = &#39; $file_name &#39;</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">var_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">var_phil</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root_name</span> <span class="o">=</span> <span class="n">peak</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;peak.mtz&quot;</span>
<span class="n">full_path</span> <span class="o">=</span> <span class="s2">&quot;/net/cci/rwgk/peak.mtz&quot;</span>
<span class="n">related_file_name</span> <span class="o">=</span> <span class="s2">&quot;peak_data.mtz&quot;</span>
<span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Reading peak.mtz&quot;</span>
<span class="n">as_is</span> <span class="o">=</span> <span class="s1">&#39; $file_name &#39;</span>
</pre></div>
</div>
<p>Note that the variable substitution does not happen during parsing.
The output of <code class="docutils literal notranslate"><span class="pre">params.show</span></code> is identical to the input. In the
example above, variables are substituted by the <code class="docutils literal notranslate"><span class="pre">.fetch()</span></code> method
that we introduced earlier to merge user files given a master file.</p>
</div>
<div class="section" id="extending-phil">
<h2><a class="toc-backref" href="#id14">Extending Phil</a><a class="headerlink" href="#extending-phil" title="Permalink to this headline">¶</a></h2>
<p>Phil comes with a number of predefined converters used by <code class="docutils literal notranslate"><span class="pre">.extract()</span></code>
and <code class="docutils literal notranslate"><span class="pre">.format()</span></code> to convert to and from pure Python objects. These
are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">type</span> <span class="o">=</span>
  <span class="n">words</span>     <span class="n">retains</span> <span class="n">the</span> <span class="s2">&quot;words&quot;</span> <span class="n">produced</span> <span class="n">by</span> <span class="n">the</span> <span class="n">parser</span>
  <span class="n">strings</span>   <span class="nb">list</span> <span class="n">of</span> <span class="n">Python</span> <span class="n">strings</span> <span class="p">(</span><span class="n">also</span> <span class="n">used</span> <span class="k">for</span> <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
  <span class="nb">str</span>       <span class="n">combines</span> <span class="nb">all</span> <span class="n">words</span> <span class="n">into</span> <span class="n">one</span> <span class="n">string</span>
  <span class="n">path</span>      <span class="n">path</span> <span class="n">name</span> <span class="p">(</span><span class="n">same</span> <span class="k">as</span> <span class="n">str_converters</span><span class="p">)</span>
  <span class="n">key</span>       <span class="n">database</span> <span class="n">key</span> <span class="p">(</span><span class="n">same</span> <span class="k">as</span> <span class="n">str_converters</span><span class="p">)</span>
  <span class="nb">bool</span>      <span class="n">Python</span> <span class="nb">bool</span>
  <span class="nb">int</span>       <span class="n">Python</span> <span class="nb">int</span>
  <span class="nb">float</span>     <span class="n">Python</span> <span class="nb">float</span>
  <span class="n">choice</span>    <span class="n">string</span> <span class="n">selected</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">pre</span><span class="o">-</span><span class="n">defined</span> <span class="nb">list</span>
</pre></div>
</div>
<p>It is possible to extend Phil with user-defined converters.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="kn">import</span> <span class="nn">libtbx.phil</span>
<span class="kn">from</span> <span class="nn">libtbx.phil</span> <span class="kn">import</span> <span class="n">tokenizer</span>

<span class="k">class</span> <span class="nc">upper_converters</span><span class="p">:</span>

  <span class="n">phil_type</span> <span class="o">=</span> <span class="s2">&quot;upper&quot;</span>

  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phil_type</span>

  <span class="k">def</span> <span class="nf">from_words</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">master</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">str_from_words</span><span class="p">(</span><span class="n">words</span><span class="o">=</span><span class="n">words</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">as_words</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python_object</span><span class="p">,</span> <span class="n">master</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">python_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">word</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">word</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">python_object</span><span class="o">.</span><span class="n">upper</span><span class="p">())]</span>

<span class="n">converter_registry</span> <span class="o">=</span> <span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">extended_converter_registry</span><span class="p">(</span>
  <span class="n">additional_converters</span><span class="o">=</span><span class="p">[</span><span class="n">upper_converters</span><span class="p">])</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>The extended <code class="docutils literal notranslate"><span class="pre">converter_registry</span></code> is passed as an additional
argument to Phil’s <code class="docutils literal notranslate"><span class="pre">parse</span></code> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  value = None</span>
<span class="s2">    .type = upper</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">converter_registry</span><span class="o">=</span><span class="n">converter_registry</span><span class="p">)</span>
<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;value = extracted&quot;</span><span class="p">)</span>
<span class="n">working_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">value</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">print</span></code> statement at the end writes “EXTRACTED”. It also goes
the other way, starting with a lower-case Python value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_params</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;formatted&quot;</span>
<span class="n">working_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">python_object</span><span class="o">=</span><span class="n">working_params</span><span class="p">)</span>
<span class="n">working_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>The output of the <code class="docutils literal notranslate"><span class="pre">.show()</span></code> call is “value = FORMATTED”.</p>
<p>Arbitrary new types can be added to Phil by defining similar
converters. If desired, the pre-defined converters for the basic
types can even be replaced. All converters have to have <code class="docutils literal notranslate"><span class="pre">__str__()</span></code>,
<code class="docutils literal notranslate"><span class="pre">from_words()</span></code> and <code class="docutils literal notranslate"><span class="pre">as_words()</span></code> methods. More complex converters
may optionally have a non-trivial <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method (an example
is the <code class="docutils literal notranslate"><span class="pre">choice_converters</span></code> class in <code class="docutils literal notranslate"><span class="pre">libtbx/phil/__init__.py</span></code>).</p>
<p>Additional domain-specific converters are best defined in a separate
module, along with a corresponding parse() function using the
extended converter registry as the default. See, for example,
<code class="docutils literal notranslate"><span class="pre">iotbx/phil.py</span></code> in the same <code class="docutils literal notranslate"><span class="pre">cctbx</span></code> project that also hosts
<code class="docutils literal notranslate"><span class="pre">libtbx</span></code>.</p>
</div>
<div class="section" id="details">
<h2><a class="toc-backref" href="#id15">Details</a><a class="headerlink" href="#details" title="Permalink to this headline">¶</a></h2>
<div class="section" id="type-ints-and-type-floats">
<h3><a class="toc-backref" href="#id16">.type = ints and .type = floats</a><a class="headerlink" href="#type-ints-and-type-floats" title="Permalink to this headline">¶</a></h3>
<p>The built-in <code class="docutils literal notranslate"><span class="pre">ints</span></code> and <code class="docutils literal notranslate"><span class="pre">floats</span></code> converters handle lists of
integer and floating point numbers, respectively. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  random_integers = None</span>
<span class="s2">    .type = ints</span>
<span class="s2">  euler_angles = None</span>
<span class="s2">    .type = floats(size=3)</span>
<span class="s2">  unit_cell_parameters = None</span>
<span class="s2">    .type = floats(size_min=1, size_max=6)</span>
<span class="s2">  rotation_part = None</span>
<span class="s2">    .type = ints(size=9, value_min=-1, value_max=1)</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  random_integers = 3 18 5</span>
<span class="s2">  euler_angles = 10 -20 30</span>
<span class="s2">  unit_cell_parameters = 10,20,30</span>
<span class="s2">  rotation_part = &quot;1,0,0;0,-1,0;0,0,-1&quot;</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">working_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span>
<span class="n">working_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span>
<span class="n">working_params</span> <span class="o">=</span> <span class="n">working_phil</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">random_integers</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">euler_angles</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">unit_cell_parameters</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">rotation_part</span>
<span class="nb">print</span>
<span class="n">working_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">python_object</span><span class="o">=</span><span class="n">working_params</span><span class="p">)</span>
<span class="n">working_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">random_integers</span> <span class="o">=</span> <span class="mi">3</span> <span class="mi">18</span> <span class="mi">5</span>
<span class="n">euler_angles</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span><span class="mi">20</span> <span class="mi">30</span>
<span class="n">unit_cell_parameters</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span>
<span class="n">rotation_part</span> <span class="o">=</span> <span class="s2">&quot;1,0,0;0,-1,0;0,0,-1&quot;</span>

<span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">]</span>
<span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">random_integers</span> <span class="o">=</span> <span class="mi">3</span> <span class="mi">18</span> <span class="mi">5</span>
<span class="n">euler_angles</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span><span class="mi">20</span> <span class="mi">30</span>
<span class="n">unit_cell_parameters</span> <span class="o">=</span> <span class="mi">10</span> <span class="mi">20</span> <span class="mi">30</span>
<span class="n">rotation_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>The list of <code class="docutils literal notranslate"><span class="pre">random_integers</span></code> can have arbitrary size and arbitrary
values.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">euler_angles</span></code>, exactly three values must be given.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">unit_cell_parameters</span></code>, one to six values are acceptable.</p>
<p>The list of values for <code class="docutils literal notranslate"><span class="pre">rotation_part</span></code> must have nine integer
elements, with values {-1,0,1}.</p>
<p>All keywords are optional and can be used in any combination, except if
<code class="docutils literal notranslate"><span class="pre">size</span></code> is given, <code class="docutils literal notranslate"><span class="pre">size_min</span></code> and <code class="docutils literal notranslate"><span class="pre">size_max</span></code> cannot also be given.</p>
<p>Lists of values can optionally use commas or semicolons as separators
between values. In this context, both characters are equivalent to
a white-space. <code class="docutils literal notranslate"><span class="pre">.format()</span></code> always uses spaces as separators, i.e.
commas and semicolons are not preserved in an <code class="docutils literal notranslate"><span class="pre">.extract()</span></code>-<code class="docutils literal notranslate"><span class="pre">.format()</span></code>
cycle. (Note that lists using semicolons as separators must be quoted;
see the “Semicolon syntax” section below.)</p>
</div>
<div class="section" id="type-choice">
<h3><a class="toc-backref" href="#id17">.type = choice</a><a class="headerlink" href="#type-choice" title="Permalink to this headline">¶</a></h3>
<p>The built-in <code class="docutils literal notranslate"><span class="pre">choice</span></code> converters support single and multi choices.
Here are two examples, a single choice <code class="docutils literal notranslate"><span class="pre">gender</span></code> and a multi choice
<code class="docutils literal notranslate"><span class="pre">favorite_sweets</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  gender = male female</span>
<span class="s2">    .type = choice</span>
<span class="s2">  favorite_sweets = ice_cream chocolate candy_cane cookies</span>
<span class="s2">    .type = choice(multi=True)</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">jims_choices</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  gender = *male female</span>
<span class="s2">  favorite_sweets = *ice_cream chocolate candy_cane *cookies</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">jims_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">jims_choices</span><span class="p">)</span>
<span class="n">jims_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">jims_params</span> <span class="o">=</span> <span class="n">jims_phil</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">jims_params</span><span class="o">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">jims_params</span><span class="o">.</span><span class="n">favorite_sweets</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Selected items are marked with a star <code class="docutils literal notranslate"><span class="pre">*</span></code>. The <code class="docutils literal notranslate"><span class="pre">.extract()</span></code>
method returns either a string with the selected value (single choice)
or a list of strings with all selected values (multi choice). The
output of the example is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gender</span> <span class="o">=</span> <span class="o">*</span><span class="n">male</span> <span class="n">female</span>
<span class="n">favorite_sweets</span> <span class="o">=</span> <span class="o">*</span><span class="n">ice_cream</span> <span class="n">chocolate</span> <span class="n">candy_cane</span> <span class="o">*</span><span class="n">cookies</span>
<span class="n">male</span> <span class="p">[</span><span class="s1">&#39;ice_cream&#39;</span><span class="p">,</span> <span class="s1">&#39;cookies&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>To maximize convenience, especially for choices specified via the
command-line, the <code class="docutils literal notranslate"><span class="pre">*</span></code> is optional if only one value is given.
For example, the following two definitions are equivalent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gender</span> <span class="o">=</span> <span class="n">female</span>
<span class="n">gender</span> <span class="o">=</span> <span class="n">male</span> <span class="o">*</span><span class="n">female</span>
</pre></div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">.optional</span></code> attribute is not defined, it defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>
and this is possible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">ignorant_choices</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  gender = male female</span>
<span class="s2">  favorite_sweets = ice_cream chocolate candy_cane cookies</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">ignorant_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ignorant_choices</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">ignorant_params</span><span class="o">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">ignorant_params</span><span class="o">.</span><span class="n">favorite_sweets</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kc">None</span> <span class="p">[]</span>
</pre></div>
</div>
<p>In this case the application has to deal with the <code class="docutils literal notranslate"><span class="pre">None</span></code> and
the empty list. If <code class="docutils literal notranslate"><span class="pre">.optional</span> <span class="pre">=</span> <span class="pre">False</span></code>, <code class="docutils literal notranslate"><span class="pre">.extract()</span></code> will lead
to informative error messages. The application will never receive
<code class="docutils literal notranslate"><span class="pre">None</span></code> or an empty list.</p>
<p>If a value in the user file is not a possible choice, <code class="docutils literal notranslate"><span class="pre">.extract()</span></code>
leads to an error message listing all possible choices, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sorry</span><span class="p">:</span> <span class="n">Not</span> <span class="n">a</span> <span class="n">possible</span> <span class="n">choice</span> <span class="k">for</span> <span class="n">favorite_sweets</span><span class="p">:</span> <span class="n">icecream</span>
  <span class="n">Possible</span> <span class="n">choices</span> <span class="n">are</span><span class="p">:</span>
    <span class="n">ice_cream</span>
    <span class="n">chocolate</span>
    <span class="n">candy_cane</span>
    <span class="n">cookies</span>
</pre></div>
</div>
<p>This message is designed to aid users in recovering from mis-spelled
choices typed in at the command-line. Command-line choices are
further supported by this syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">greedy_choices</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  favorite_sweets=ice_cream+chocolate+cookies</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">greedy_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">greedy_choices</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">greedy_params</span><span class="o">.</span><span class="n">favorite_sweets</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Ouput:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;ice_cream&#39;</span><span class="p">,</span> <span class="s1">&#39;chocolate&#39;</span><span class="p">,</span> <span class="s1">&#39;cookies&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Finally, if the <code class="docutils literal notranslate"><span class="pre">.optional</span></code> attribute is not specified or <code class="docutils literal notranslate"><span class="pre">True</span></code>,
<code class="docutils literal notranslate"><span class="pre">None</span></code> can be assigned:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">no_thanks_choices</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  favorite_sweets=None</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">no_thanks_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">no_thanks_choices</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">no_thanks_params</span><span class="o">.</span><span class="n">favorite_sweets</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[]</span>
</pre></div>
</div>
</div>
<div class="section" id="scope-extract">
<h3><a class="toc-backref" href="#id18">scope_extract</a><a class="headerlink" href="#scope-extract" title="Permalink to this headline">¶</a></h3>
<p>The result of <code class="docutils literal notranslate"><span class="pre">scope.extract()</span></code> is a <code class="docutils literal notranslate"><span class="pre">scope_extract</span></code> instance
with attributes corresponding to the embedded definitions and
sub-scopes. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.input {</span>
<span class="s2">    file_name = None</span>
<span class="s2">      .type = path</span>
<span class="s2">  }</span>
<span class="s2">  minimization.parameters {</span>
<span class="s2">    max_iterations = 10</span>
<span class="s2">      .type = int</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization.input.file_name = experiment.dat</span>
<span class="s2">  minimization.parameters.max_iterations = 5</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">working_params</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">working_params</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">file_name</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_iterations</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">scope_extract</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2ad50bae7550</span><span class="o">&gt;</span>
<span class="n">experiment</span><span class="o">.</span><span class="n">dat</span>
<span class="mi">5</span>
</pre></div>
</div>
<p>This just repeats what was shown several times before, but
<code class="docutils literal notranslate"><span class="pre">scope_extract</span></code> includes a few additional, special features that are
worth knowing. The first special feature is the <code class="docutils literal notranslate"><span class="pre">.__phil_path__()</span></code>
method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">__phil_path__</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">__phil_path__</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span>
<span class="n">minimization</span><span class="o">.</span><span class="n">parameters</span>
</pre></div>
</div>
<p>This feature is most useful for formatting informative error messages
without having to hard-wire the fully-qualified parameter names. Use
<code class="docutils literal notranslate"><span class="pre">.__phil_path__()</span></code> to ensure that the names are automatically
correct even if the master file is changed in major ways. Note that the
<code class="docutils literal notranslate"><span class="pre">.__phil_path__()</span></code> method is available only for extracted scopes,
not for extracted definitions since it would be very cumbersome to
implement. However, the fully-qualified name of a definition can
be obtained via <code class="docutils literal notranslate"><span class="pre">.__phil_path__(object_name=&quot;max_iterations&quot;)</span></code>;
usually the <code class="docutils literal notranslate"><span class="pre">object_name</span></code> is readily available in the contexts in
which the fully-qualified name is needed. There is also
<code class="docutils literal notranslate"><span class="pre">.__phil_path_and_value__(object_name)</span></code> which returns a 2-tuple
of the fully-qualified path and the extracted value, ready to
be used for formatting error messages.</p>
<p>The next important feature is a safety guard: assignment to a
non-existing attribute leads to an exception. For example,
if the attribute is mis-spelled:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">working_params</span><span class="o">.</span><span class="n">minimization</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;other.dat&quot;</span>
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ne">AttributeError</span><span class="p">:</span> <span class="n">Assignment</span> <span class="n">to</span> <span class="n">non</span><span class="o">-</span><span class="n">existing</span> <span class="n">attribute</span> <span class="s2">&quot;minimization.input.filename&quot;</span>
  <span class="n">Please</span> <span class="n">correct</span> <span class="n">the</span> <span class="n">attribute</span> <span class="n">name</span><span class="p">,</span> <span class="ow">or</span> <span class="n">to</span> <span class="n">create</span>
  <span class="n">a</span> <span class="n">new</span> <span class="n">attribute</span> <span class="n">use</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">__inject__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition to trivial spelling errors, the safety guard traps
overlooked dependencies related to changes in the master file.</p>
<p>In some (unusual) situations it may be useful to attach attributes to
an extracted scope that have no correspondence in the master file.
Use the <code class="docutils literal notranslate"><span class="pre">.__inject__(name,</span> <span class="pre">value)</span></code> method for this purpose to
by-pass the safety-guard. As a side-effect of this design, injected
attributes are easily pin-pointed in the source code (simply search
for <code class="docutils literal notranslate"><span class="pre">__inject__</span></code>), which can be a big help in maintaining a large
code base.</p>
</div>
<div class="section" id="multiple-definitions-and-scopes">
<h3><a class="toc-backref" href="#id19">Multiple definitions and scopes</a><a class="headerlink" href="#multiple-definitions-and-scopes" title="Permalink to this headline">¶</a></h3>
<p>All Phil attributes of multiple definitions or scopes are determined
by the first occurrence in the master file. All following instances in
the master file are defaults. Any instances in user files (merged via
<code class="docutils literal notranslate"><span class="pre">.fetch()</span></code>) are added to the default instances in the master file.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  plot</span>
<span class="s2">    .multiple = True</span>
<span class="s2">  {</span>
<span class="s2">    style = line bar pie_chart</span>
<span class="s2">      .type=choice</span>
<span class="s2">    title = None</span>
<span class="s2">      .type = str</span>
<span class="s2">  }</span>
<span class="s2">  plot {</span>
<span class="s2">    style = line</span>
<span class="s2">    title = Line plot (default in master)</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  plot {</span>
<span class="s2">    style = bar</span>
<span class="s2">    title = Bar plot (provided by user)</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">working_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span>
<span class="n">working_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="p">{</span>
  <span class="n">style</span> <span class="o">=</span> <span class="o">*</span><span class="n">line</span> <span class="n">bar</span> <span class="n">pie_chart</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">Line</span> <span class="n">plot</span> <span class="p">(</span><span class="n">default</span> <span class="ow">in</span> <span class="n">master</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">plot</span> <span class="p">{</span>
  <span class="n">style</span> <span class="o">=</span> <span class="n">line</span> <span class="o">*</span><span class="n">bar</span> <span class="n">pie_chart</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="p">(</span><span class="n">provided</span> <span class="n">by</span> <span class="n">user</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">.extract()</span></code> will produce a list with two elements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_params</span> <span class="o">=</span> <span class="n">working_phil</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">working_params</span><span class="o">.</span><span class="n">plot</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">&lt;</span><span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">scope_extract</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2b1ccb5b1910</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">scope_extract</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2b1ccb5b1c10</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that the first (i.e. master) occurrence of the scope is not
extracted. In practice this is usually the desired behavior, but it
can be changed by setting the <code class="docutils literal notranslate"><span class="pre">plot</span></code> scope attribute <code class="docutils literal notranslate"><span class="pre">.optional</span>
<span class="pre">=</span> <span class="pre">False</span></code>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  plot</span>
<span class="s2">    .multiple = True</span>
<span class="s2">    .optional = False</span>
<span class="s2">  {</span>
<span class="s2">    style = line bar pie_chart</span>
<span class="s2">      .type=choice</span>
<span class="s2">    title = None</span>
<span class="s2">      .type = str</span>
<span class="s2">  }</span>
<span class="s2">  plot {</span>
<span class="s2">    style = line</span>
<span class="s2">    title = Line plot (default in master)</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">user_phil</span></code> as before, <code class="docutils literal notranslate"><span class="pre">.show()</span></code> and <code class="docutils literal notranslate"><span class="pre">.extract()</span></code> now
produce three entries each:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">working_phil</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span>
<span class="n">working_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">working_phil</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="p">{</span>
  <span class="n">style</span> <span class="o">=</span> <span class="n">line</span> <span class="n">bar</span> <span class="n">pie_chart</span>
  <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">}</span>
<span class="n">plot</span> <span class="p">{</span>
  <span class="n">style</span> <span class="o">=</span> <span class="o">*</span><span class="n">line</span> <span class="n">bar</span> <span class="n">pie_chart</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">Line</span> <span class="n">plot</span> <span class="p">(</span><span class="n">default</span> <span class="ow">in</span> <span class="n">master</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">plot</span> <span class="p">{</span>
  <span class="n">style</span> <span class="o">=</span> <span class="n">line</span> <span class="o">*</span><span class="n">bar</span> <span class="n">pie_chart</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">Bar</span> <span class="n">plot</span> <span class="p">(</span><span class="n">provided</span> <span class="n">by</span> <span class="n">user</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">scope_extract</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2af4c307bcd0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">scope_extract</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2af4c307bd50</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">libtbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">scope_extract</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2af4c307be10</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">.optional</span> <span class="pre">=</span> <span class="pre">True</span></code>, the master of a multiple definition or
scope is <em>never</em> extracted. With <code class="docutils literal notranslate"><span class="pre">.optional</span> <span class="pre">=</span> <span class="pre">False</span></code>, it is <em>always</em>
extracted, and always first in the list.</p>
<p>The “always first in the list” rule for multiple master objects is
special. Other instances of multiple scopes are shown and extracted
in the order in which they appear in the master file and the merged
user file(s), with all <em>exact</em> duplicates removed. If duplicates are
detected, the earlier copy is removed, unless it is the master.</p>
<p>These rules are designed to produce easily predictable results in
situations where multiple Phil files are merged (via <code class="docutils literal notranslate"><span class="pre">.fetch()</span></code>),
including complete copies of the master file.</p>
</div>
<div class="section" id="fetch-option-track-unused-definitions">
<h3><a class="toc-backref" href="#id20">fetch option: track_unused_definitions</a><a class="headerlink" href="#fetch-option-track-unused-definitions" title="Permalink to this headline">¶</a></h3>
<p>The default behavior of <code class="docutils literal notranslate"><span class="pre">.fetch()</span></code> is to simply ignore user
definitions that don’t match anything in the master file. It it is
possible to request a complete list of all user definitions ignored by
<code class="docutils literal notranslate"><span class="pre">.fetch()</span></code>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  input {</span>
<span class="s2">    file_name = None</span>
<span class="s2">      .type = path</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  input {</span>
<span class="s2">    file_name = experiment.dat</span>
<span class="s2">    label = set1</span>
<span class="s2">    lable = set2</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">working_phil</span><span class="p">,</span> <span class="n">unused</span> <span class="o">=</span> <span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
  <span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">,</span> <span class="n">track_unused_definitions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">working_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">for</span> <span class="n">object_locator</span> <span class="ow">in</span> <span class="n">unused</span><span class="p">:</span>
  <span class="nb">print</span> <span class="s2">&quot;unused:&quot;</span><span class="p">,</span> <span class="n">object_locator</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="p">{</span>
  <span class="n">file_name</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">dat</span>
<span class="p">}</span>
<span class="n">unused</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">label</span> <span class="p">(</span><span class="nb">input</span> <span class="n">line</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">unused</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">lable</span> <span class="p">(</span><span class="nb">input</span> <span class="n">line</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>To catch spelling errors, or to alert users to changes in the master
file, it is good practice to set <code class="docutils literal notranslate"><span class="pre">track_unused_definitions=True</span></code>
and to show warnings or errors.</p>
</div>
<div class="section" id="semicolon-syntax">
<h3><a class="toc-backref" href="#id21">Semicolon syntax</a><a class="headerlink" href="#semicolon-syntax" title="Permalink to this headline">¶</a></h3>
<p>In all the examples above, line breaks act as syntactical elements
delineating the end of definitions. This is most obvious, but for
convenience, Phil also supports using the semicolon <code class="docutils literal notranslate"><span class="pre">;</span></code> instead.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">phil_scope</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">   quick .multiple=true;.optional=false{and=very;.type=str;dirty=use only on command-lines, please!;.type=str}</span>
<span class="s2">   &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">phil_scope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">attributes_level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Clearly, the output looks much nicer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>quick
  .optional = False
  .multiple = True
{
  and = very
    .type = str
  dirty = use only on command-lines, please!
    .type = str
}
</pre></div>
</div>
<p>Master files generally shouldn’t make use of the semicolon syntax, even
though it is possible. In user files it is more acceptable, but the main
purpose is to support passing parameters from the command line.</p>
<p>Note that the Phil output methods (<code class="docutils literal notranslate"><span class="pre">.show()</span></code>, <code class="docutils literal notranslate"><span class="pre">.as_str()</span></code>) never
make use of the semicolon syntax.</p>
</div>
<div class="section" id="phil-comments">
<h3><a class="toc-backref" href="#id22">Phil comments</a><a class="headerlink" href="#phil-comments" title="Permalink to this headline">¶</a></h3>
<p>Phil supports two types of comments:</p>
<blockquote>
<div><ul class="simple">
<li><p>Simple one-line comments starting with a hash <code class="docutils literal notranslate"><span class="pre">#</span></code>.
All following characters through the end of the line are ignored.</p></li>
<li><p>Syntax-aware comments starting with an exclamation mark <code class="docutils literal notranslate"><span class="pre">!</span></code>.</p></li>
</ul>
</div></blockquote>
<p>The exclamation mark can be used to easily comment out entire
syntactical constructs, for example a complete scope including all
attributes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  !input {</span>
<span class="s2">    file_name = None</span>
<span class="s2">      .type = path</span>
<span class="s2">      .multiple = True</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">master_phil</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!input {
  file_name = None
}
</pre></div>
</div>
<p>As is evident from the output, Phil keeps the content “in mind”,
but the scope is not actually used by <code class="docutils literal notranslate"><span class="pre">.fetch()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">user_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  input.file_name = experiment.dat</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">master_phil</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_phil</span><span class="p">)</span><span class="o">.</span><span class="n">as_str</span><span class="p">())</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span>
</pre></div>
</div>
<p>I.e. the <code class="docutils literal notranslate"><span class="pre">.fetch()</span></code> method ignored the user definition because the
corresponding master is commented out.</p>
</div>
<div class="section" id="quotes-and-backslash">
<h3><a class="toc-backref" href="#id23">Quotes and backslash</a><a class="headerlink" href="#quotes-and-backslash" title="Permalink to this headline">¶</a></h3>
<p>Similar to Python, Phil supports single quotes, double quotes,
and triple quotes (three single or three double quotes). Unlike
Python, quotes can often be omitted, and single quotes and double
quotes have different semantics, similar to that of Unix shells:
<code class="docutils literal notranslate"><span class="pre">$</span></code> variables are expanded if embedded in double quotes, but not
if embedded in single quotes. See the variable substitution section
above for examples.</p>
<p>The backslash can be used in the usual way (Python, Unix shells) to
“escape” line breaks, quotes, and a second backslash.</p>
<p>For convenience, a line starting with quotes is automatically treated
as a continuation of a definition on the previous line(s). The trailing
backslash on the previous line may be omitted.</p>
<p>The exact rules for quoting and backslash escapes are intricate.
A significant effort was made to mimic the familiar behavior of Python
and Unix shells where possible, but nested constructs of quotes and
backslashes are still prone to cause surprises. In unusual situations,
probably the fastest method to obtain the desired result is trial
and error (as opposed to studying the intricate rules).</p>
</div>
<div class="section" id="scope-show-attributes-level-3">
<h3><a class="toc-backref" href="#id24">scope.show(attributes_level=3)</a><a class="headerlink" href="#scope-show-attributes-level-3" title="Permalink to this headline">¶</a></h3>
<p>In this document, the <code class="docutils literal notranslate"><span class="pre">scope.show()</span></code> method is used extensively
in the examples. With the defaults for the method parameters, it
only shows the Phil scope or definition names and and associated
values. It is also possible to include some or all Phil scope or
definition attributes in the <code class="docutils literal notranslate"><span class="pre">.show()</span></code> output, as directed by the
<code class="docutils literal notranslate"><span class="pre">attributes_level</span></code> parameter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">attributes_level</span><span class="o">=</span><span class="mi">0</span><span class="p">:</span> <span class="n">shows</span> <span class="n">only</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">values</span>
                 <span class="mi">1</span><span class="p">:</span> <span class="n">also</span> <span class="n">shows</span> <span class="n">the</span> <span class="o">.</span><span class="n">help</span> <span class="n">attribute</span>
                 <span class="mi">2</span><span class="p">:</span> <span class="n">shows</span> <span class="nb">all</span> <span class="n">attributes</span> <span class="n">which</span> <span class="n">are</span> <span class="ow">not</span> <span class="kc">None</span>
                 <span class="mi">3</span><span class="p">:</span> <span class="n">shows</span> <span class="nb">all</span> <span class="n">attributes</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">scope.show(attributes_level=2)</span></code> can be used to pretty-print
master files without any loss of information. <code class="docutils literal notranslate"><span class="pre">attributes_level=3</span></code>
is useful to obtain a full listing of all available attributes,
but all information is preserved with the usually much less verbose
<code class="docutils literal notranslate"><span class="pre">attributes_level=2</span></code>. This is illustrated by the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## extract code begin: libtbx_phil_examples.py</span>

<span class="n">master_phil</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  minimization {</span>
<span class="s2">    input</span>
<span class="s2">      .help = &quot;File names and data labels.&quot;</span>
<span class="s2">      .multiple = True</span>
<span class="s2">    {</span>
<span class="s2">      file_name = None</span>
<span class="s2">        .type = path</span>
<span class="s2">      label = None</span>
<span class="s2">        .help = &quot;A unique substring of the data label is sufficient.&quot;</span>
<span class="s2">        .type = str</span>
<span class="s2">    }</span>
<span class="s2">  }</span>
<span class="s2">  &quot;&quot;&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">attributes_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
  <span class="n">master_phil</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">attributes_level</span><span class="o">=</span><span class="n">attributes_level</span><span class="p">)</span>

<span class="c1">## extract code end</span>
</pre></div>
</div>
<p>Output with <code class="docutils literal notranslate"><span class="pre">attributes_level=0</span></code> (the default):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span> <span class="p">{</span>
  <span class="nb">input</span> <span class="p">{</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Output with <code class="docutils literal notranslate"><span class="pre">attributes_level=1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span> <span class="p">{</span>
  <span class="nb">input</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;File names and data labels.&quot;</span>
  <span class="p">{</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;A unique substring of the data label is sufficient.&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Output with <code class="docutils literal notranslate"><span class="pre">attributes_level=2</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span> <span class="p">{</span>
  <span class="nb">input</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;File names and data labels.&quot;</span>
    <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="p">{</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">path</span>
    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;A unique substring of the data label is sufficient.&quot;</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Output with <code class="docutils literal notranslate"><span class="pre">attributes_level=3</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minimization</span>
  <span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">sequential_format</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">disable_add</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">disable_delete</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">{</span>
  <span class="nb">input</span>
    <span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;File names and data labels.&quot;</span>
    <span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="o">.</span><span class="n">sequential_format</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">disable_add</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">disable_delete</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="p">{</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">path</span>
      <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;A unique substring of the data label is sufficient.&quot;</span>
      <span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">short_caption</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span>
      <span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="o">.</span><span class="n">expert_level</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="api-documentation-for-phil-definition">
<h2><a class="toc-backref" href="#id25">API documentation for PHIL definition</a><a class="headerlink" href="#api-documentation-for-phil-definition" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="libtbx.phil.scope">
<em class="property"><span class="pre">class</span> </em><code class="sig-prename descclassname"><span class="pre">libtbx.phil.</span></code><code class="sig-name descname"><span class="pre">scope</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">objects</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">primary_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">primary_parent_scope</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_disabled</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_template</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">where_str</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merge_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">style</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">help</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">caption</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">short_caption</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">optional</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">call</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">multiple</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sequential_format</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">disable_add</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">disable_delete</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expert_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alias</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#libtbx.phil.scope" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="api-documentation-for-phil-scope">
<h2><a class="toc-backref" href="#id26">API documentation for PHIL scope</a><a class="headerlink" href="#api-documentation-for-phil-scope" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="id0">
<em class="property"><span class="pre">class</span> </em><code class="sig-prename descclassname"><span class="pre">libtbx.phil.</span></code><code class="sig-name descname"><span class="pre">scope</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">objects</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">primary_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">primary_parent_scope</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_disabled</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_template</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">where_str</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merge_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">style</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">help</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">caption</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">short_caption</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">optional</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">call</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">multiple</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sequential_format</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">disable_add</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">disable_delete</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expert_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alias</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#id0" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="module-libtbx.phil.command_line">
<span id="command-line-input"></span><h2><a class="toc-backref" href="#id27">Command-line input</a><a class="headerlink" href="#module-libtbx.phil.command_line" title="Permalink to this headline">¶</a></h2>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">libtbx.phil - Python-based hierarchical interchange language</a><ul>
<li><a class="reference internal" href="#phil-overview">Phil overview</a></li>
<li><a class="reference internal" href="#beyond-syntax">Beyond syntax</a></li>
<li><a class="reference internal" href="#master-files">Master files</a></li>
<li><a class="reference internal" href="#user-files">User files</a></li>
<li><a class="reference internal" href="#command-line-arguments">Command-line arguments</a></li>
<li><a class="reference internal" href="#fetch-merging-of-phil-objects">fetch: merging of Phil objects</a></li>
<li><a class="reference internal" href="#extract-conversion-of-phil-objects-to-python-objects">extract: conversion of Phil objects to Python objects</a></li>
<li><a class="reference internal" href="#format-conversion-of-python-objects-to-phil-objects">format: conversion of Python objects to Phil objects</a></li>
<li><a class="reference internal" href="#multiple-true">.multiple = True</a></li>
<li><a class="reference internal" href="#fetch-diff-difference-between-master-phil-and-working-phil">fetch_diff: difference between master_phil and working_phil</a></li>
<li><a class="reference internal" href="#includes">Includes</a></li>
<li><a class="reference internal" href="#variable-substitution">Variable substitution</a></li>
<li><a class="reference internal" href="#extending-phil">Extending Phil</a></li>
<li><a class="reference internal" href="#details">Details</a><ul>
<li><a class="reference internal" href="#type-ints-and-type-floats">.type = ints and .type = floats</a></li>
<li><a class="reference internal" href="#type-choice">.type = choice</a></li>
<li><a class="reference internal" href="#scope-extract">scope_extract</a></li>
<li><a class="reference internal" href="#multiple-definitions-and-scopes">Multiple definitions and scopes</a></li>
<li><a class="reference internal" href="#fetch-option-track-unused-definitions">fetch option: track_unused_definitions</a></li>
<li><a class="reference internal" href="#semicolon-syntax">Semicolon syntax</a></li>
<li><a class="reference internal" href="#phil-comments">Phil comments</a></li>
<li><a class="reference internal" href="#quotes-and-backslash">Quotes and backslash</a></li>
<li><a class="reference internal" href="#scope-show-attributes-level-3">scope.show(attributes_level=3)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-documentation-for-phil-definition">API documentation for PHIL definition</a></li>
<li><a class="reference internal" href="#api-documentation-for-phil-scope">API documentation for PHIL scope</a></li>
<li><a class="reference internal" href="#module-libtbx.phil.command_line">Command-line input</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">libtbx - low-level utilities and infrastructure for CCTBX</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="libtbx.easy_mp.html"
                        title="next chapter">libtbx.easy_mp: functions for painless parallelization of Python code</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/libtbx/libtbx.phil.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="libtbx.easy_mp.html" title="libtbx.easy_mp: functions for painless parallelization of Python code"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="libtbx - low-level utilities and infrastructure for CCTBX"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CCTBX Developer documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >libtbx - low-level utilities and infrastructure for CCTBX</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">libtbx.phil - Python-based hierarchical interchange language</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, University of California.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.3.
    </div>
  </body>
</html>